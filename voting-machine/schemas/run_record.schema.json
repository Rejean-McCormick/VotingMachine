{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/schemas/run_record.schema.json",
  "title": "RunRecord (Provenance Envelope)",
  "description": "Signed/attested provenance of one execution: inputs, policy, platform, and output references. Strict; no unknown fields.",
  "$defs": {
    "hex64": { "type": "string", "pattern": "^[0-9a-f]{64}$", "title": "Hex64Lower" },

    "run_id": {
      "type": "string",
      "pattern": "^RUN:[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z-[0-9a-f]{8,64}$",
      "title": "RunId",
      "$comment": "RUN:<UTC-timestamp>-<hash>; UTC Z enforced here."
    },

    "res_id":  { "type": "string", "pattern": "^RES:[0-9a-f]{64}$", "title": "ResultId" },
    "fr_id":   { "type": "string", "pattern": "^FR:[0-9a-f]{64}$",  "title": "FrontierMapId" },
    "man_id":  { "type": "string", "pattern": "^MAN:[0-9a-f]{64}$", "title": "ManifestId" },
    "reg_id":  { "type": "string", "pattern": "^REG:[0-9a-f]{64}$", "title": "RegistryId" },
    "ps_id":   { "type": "string", "pattern": "^PS:[0-9a-f]{64}$",  "title": "ParameterSetId" },
    "tly_id":  { "type": "string", "pattern": "^TLY:[0-9a-f]{64}$", "title": "BallotTallyId" },
    "bal_id":  { "type": "string", "pattern": "^BAL:[A-Za-z0-9_.:-]{1,64}$", "title": "RawBallotsId" },

    "digest_entry": {
      "type": "object",
      "required": ["sha256"],
      "properties": { "sha256": { "$ref": "#/$defs/hex64" } },
      "additionalProperties": false,
      "title": "DigestEntry"
    }
  },

  "type": "object",
  "required": ["id", "timestamp_utc", "engine", "inputs", "policy", "platform", "outputs"],
  "additionalProperties": false,

  "properties": {
    "id": { "$ref": "#/$defs/run_id" },

    "timestamp_utc": {
      "type": "string",
      "format": "date-time",
      "pattern": "Z$",
      "title": "TimestampUTC",
      "$comment": "RFC3339 UTC (must end with 'Z')."
    },

    "engine": {
      "type": "object",
      "required": ["engine_version", "formula_id", "formula_manifest_sha256"],
      "additionalProperties": false,
      "properties": {
        "engine_version": { "type": "string" },
        "formula_id": { "$ref": "#/$defs/hex64" },
        "formula_manifest_sha256": { "$ref": "#/$defs/hex64" }
      }
    },

    "inputs": {
      "type": "object",
      "required": ["reg_id", "parameter_set_id", "adjacency_present", "digests"],
      "additionalProperties": false,
      "properties": {
        "manifest_id": { "$ref": "#/$defs/man_id" },
        "reg_id": { "$ref": "#/$defs/reg_id" },
        "parameter_set_id": { "$ref": "#/$defs/ps_id" },

        "ballots_id": { "$ref": "#/$defs/bal_id" },
        "ballot_tally_id": { "$ref": "#/$defs/tly_id" },

        "adjacency_present": { "type": "boolean" },

        "digests": {
          "type": "object",
          "additionalProperties": { "$ref": "#/$defs/digest_entry" },
          "title": "InputDigests",
          "$comment": "Map: relative path â†’ { sha256: <64-hex> } for every input file loaded."
        }
      },

      "oneOf": [
        { "required": ["ballots_id"], "not": { "required": ["ballot_tally_id"] } },
        { "required": ["ballot_tally_id"], "not": { "required": ["ballots_id"] } }
      ]
    },

    "policy": {
      "type": "object",
      "required": ["tie_policy"],
      "additionalProperties": false,
      "properties": {
        "tie_policy": {
          "type": "string",
          "enum": ["status_quo", "deterministic_order", "random"]
        },
        "deterministic_order_key": {
          "type": "string",
          "enum": ["option_order_index"]
        },
        "rng_seed": { "$ref": "#/$defs/hex64" }
      },
      "allOf": [
        {
          "if": { "properties": { "tie_policy": { "const": "random" } }, "required": ["tie_policy"] },
          "then": { "required": ["rng_seed"] }
        },
        {
          "if": { "properties": { "tie_policy": { "const": "deterministic_order" } }, "required": ["tie_policy"] },
          "then": { "required": ["deterministic_order_key"] }
        }
      ]
    },

    "platform": {
      "type": "object",
      "required": ["os", "arch", "rustc_version", "build_profile"],
      "additionalProperties": false,
      "properties": {
        "os": { "type": "string", "enum": ["windows", "macos", "linux"] },
        "arch": { "type": "string", "pattern": "^[A-Za-z0-9_\\-]+$" },
        "rustc_version": { "type": "string" },
        "build_profile": { "type": "string", "enum": ["debug", "release"] }
      }
    },

    "outputs": {
      "type": "object",
      "required": ["result_id", "result_sha256"],
      "additionalProperties": false,
      "properties": {
        "result_id": { "$ref": "#/$defs/res_id" },
        "result_sha256": { "$ref": "#/$defs/hex64" },

        "frontier_map_id": { "$ref": "#/$defs/fr_id" },
        "frontier_map_sha256": { "$ref": "#/$defs/hex64" },

        "tie_log_summary": {
          "type": "object",
          "required": ["deterministic_ties", "randomized_ties"],
          "additionalProperties": false,
          "properties": {
            "deterministic_ties": { "type": "integer", "minimum": 0 },
            "randomized_ties": { "type": "integer", "minimum": 0 }
          }
        }
      },
      "allOf": [
        {
          "if": { "required": ["frontier_map_id"] },
          "then": { "required": ["frontier_map_sha256"] }
        }
      ]
    },

    "notes": { "type": "string" }
  },

  "$comment": "Digests are SHA-256 over canonical bytes (UTF-8, LF, sorted keys). Result/Frontier IDs use RES:/FR: prefixes with 64-hex. The RUN: id embeds UTC time and a hash suffix."
}
